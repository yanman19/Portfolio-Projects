import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from sklearn.metrics import mean_absolute_error, mean_squared_error

def nepool_price_forecast_temp(df,
                               S0=13.4, Fmax=1.9, conv=0.186,
                               henry=3, basis0=5,
                               heat_rate=7.5, nonfuel=15,
                               T_ref=35, alpha=0.6, beta=1.0,   # sensitivity tuned up
                               ttf_landed=20, cargo_size=6.7,
                               cargo_lag=14, S_trigger=4,
                               start_date=None, end_date=None,
                               add_volatility=True, sigma=0.15):
    """
    Forecast NEPOOL power prices from Bos_Temp, GasGen, and LNG storage.
    Compares to NE_MAHUB_PK (actual) and plots dual-axis chart.
    """

    # --- Filter by date range ---
    if start_date and end_date:
        df = df[(df["Date"] >= pd.to_datetime(start_date)) &
                (df["Date"] <= pd.to_datetime(end_date))].copy()
        if df.empty:
            raise ValueError("No data found between start_date and end_date.")

    S = [S0]
    prices, cargo_ordered, cargo_arrived = [], [], []
    cargo_eta = None

    for i, row in df.iterrows():
        temp = row["Bos_Temp"]
        gas_mw = row["GasGen"]
        p = gas_mw / 1000.0  # MW â†’ GW
        burn = min(Fmax, p * conv)
        s_next = max(S[-1] - burn, 0)

        # --- Cargo logic ---
        if s_next <= S_trigger and cargo_eta is None:
            cargo_eta = i + cargo_lag
            cargo_ordered.append(True)
        else:
            cargo_ordered.append(False)

        if cargo_eta == i:
            s_next = min(s_next + cargo_size, S0)
            cargo_eta = None
            cargo_arrived.append(True)
        else:
            cargo_arrived.append(False)

        # --- Gas pricing ---
        gas_price = henry + basis0
        gas_price += alpha * max(0, T_ref - temp)
        gas_price += beta * max(0, (S0 - s_next)) / S0
        gas_price = min(gas_price, ttf_landed)

        if add_volatility:
            gas_price *= np.random.normal(1, sigma)  # Â±volatility

        # --- Power price ---
        power_price = heat_rate * gas_price + nonfuel

        S.append(s_next)
        prices.append(power_price)

    df["Storage_Bcf"] = S[1:]
    df["PredictedPrice_$MWh"] = prices
    df["CargoOrdered"] = cargo_ordered
    df["CargoArrived"] = cargo_arrived

    # --- If realized price exists ---
    if "NE_MAHUB_PK" in df.columns:
        actual = df["NE_MAHUB_PK"].astype(float)
        predicted = df["PredictedPrice_$MWh"]

        mae = mean_absolute_error(actual, predicted)
        rmse = np.sqrt(mean_squared_error(actual, predicted))
        mape = np.mean(np.abs((actual - predicted) / actual)) * 100

        print("ğŸ“Š Model Performance Summary")
        print(f"MAE  : {mae:.2f} $/MWh")
        print(f"RMSE : {rmse:.2f} $/MWh")
        print(f"MAPE : {mape:.2f}%")
        print(f"Period: {df['Date'].min().date()} â†’ {df['Date'].max().date()}")
        print(f"Avg Predicted: {predicted.mean():.1f} | Avg Actual: {actual.mean():.1f}")

        # --- Dual-Axis Plot ---
        fig, ax1 = plt.subplots(figsize=(13,6))
        ax1.plot(df["Date"], actual, color="black", label="Actual NE_MAHUB_PK", linewidth=2)
        ax1.plot(df["Date"], predicted, color="tab:blue", label="Predicted Price", linewidth=2)
        ax1.set_xlabel("Date")
        ax1.set_ylabel("$/MWh")
        ax1.legend(loc="upper left")
        ax1.grid(True, alpha=0.3)

        ax2 = ax1.twinx()
        ax2.plot(df["Date"], df["Storage_Bcf"], color="tab:orange", linestyle="--", label="Storage (Bcf)")
        ax2.set_ylabel("Storage (Bcf)")
        ax2.legend(loc="upper right")

        plt.title("NEPOOL Power Price Forecast vs Actual â€” with LNG Storage")
        plt.show()

    else:
        print("âš ï¸ No 'NE_MAHUB_PK' column found â€” skipping metrics & plot.")

    return df