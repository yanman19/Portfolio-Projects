import pandas as pd

def nepool_price_forecast_temp(df,
                               S0=13.4,
                               Fmax=1.9,
                               conv=0.186,
                               henry=3,
                               basis0=5,
                               heat_rate=7.5,
                               nonfuel=15,
                               T_ref=35,
                               alpha=0.4,
                               beta=0.6,
                               ttf_landed=15,
                               cargo_size=6.7,
                               cargo_lag=14,
                               S_trigger=4):
    """
    Inputs required:
      - Date
      - Temp_F  (Â°F)
      - GasGen_GW
    """

    S = [S0]
    prices = []
    cargo_eta = None
    cargo_ordered, cargo_arrived = [], []

    for i, row in df.iterrows():
        p = row["GasGen_GW"]
        temp = row["Temp_F"]
        burn = min(Fmax, p * conv)
        s_next = max(S[-1] - burn, 0)

        # Cargo order/arrival logic
        if s_next <= S_trigger and cargo_eta is None:
            cargo_eta = i + cargo_lag
            cargo_ordered.append(True)
        else:
            cargo_ordered.append(False)

        if cargo_eta == i:
            s_next = min(s_next + cargo_size, S0)
            cargo_eta = None
            cargo_arrived.append(True)
        else:
            cargo_arrived.append(False)

        # Temperature + storage-based gas pricing
        gas_price = henry + basis0
        gas_price += alpha * max(0, T_ref - temp)          # cold premium
        gas_price += beta * max(0, (S0 - s_next)) / S0     # storage tightness premium
        gas_price = min(gas_price, ttf_landed)             # ceiling at TTF landed

        power_price = heat_rate * gas_price + nonfuel
        S.append(s_next)
        prices.append(power_price)

    df["Storage_Bcf"] = S[1:]
    df["PowerPrice_$MWh"] = prices
    df["CargoOrdered"] = cargo_ordered
    df["CargoArrived"] = cargo_arrived
    return df