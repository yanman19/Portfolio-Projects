import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from sklearn.metrics import mean_absolute_error, mean_squared_error

def nepool_price_forecast_temp(df,
                               gas_units="GW",          # "GW" or "MW"
                               S0=13.4, Fmax=1.9, conv=0.186,
                               S_trigger=4, S_min=1.0,  # minimum operating level
                               cargo_size=6.7, cargo_lag=14,
                               henry=3, basis0=5,
                               heat_rate=7.5, nonfuel=15,
                               T_ref=35, alpha=1.0, beta=1.4,
                               ttf_landed=25,
                               add_volatility=True, sigma=0.10,
                               start_date=None, end_date=None):
    """
    Forecast NEPOOL daily power prices with LNG storage + cargo logic.
    Inputs: Date, Bos_Temp (Â°F), GasGen (GW or MW), NE_MAHUB_PK (optional).
    """

    # --- Date filtering ---
    if start_date and end_date:
        df = df[(df["Date"] >= pd.to_datetime(start_date)) &
                (df["Date"] <= pd.to_datetime(end_date))].copy()
        if df.empty:
            raise ValueError("No data found between start_date and end_date.")

    S = [S0]
    prices, cargo_ordered, cargo_arrived = [], [], []
    cargo_eta = []

    for i, row in df.iterrows():
        temp = row["Bos_Temp"]
        gen_val = row["GasGen"]
        p = gen_val if gas_units == "GW" else gen_val / 1000.0

        # --- Daily burn & draw ---
        burn = min(Fmax, p * conv)
        s_next = max(S[-1] - burn, S_min)  # enforce minimum heel

        # --- Cargo scheduling logic ---
        # If below trigger and no cargo arriving soon â†’ order one
        if s_next <= S_trigger and (not cargo_eta or i > cargo_eta[-1] - cargo_lag):
            cargo_eta.append(i + cargo_lag)
            cargo_ordered.append(True)
        else:
            cargo_ordered.append(False)

        # --- Cargo arrivals (may overlap) ---
        if cargo_eta and i == cargo_eta[0]:
            s_next = min(s_next + cargo_size, S0)
            cargo_eta.pop(0)
            cargo_arrived.append(True)
        else:
            cargo_arrived.append(False)

        # --- Gas price formation ---
        gas_price = henry + basis0
        gas_price += alpha * max(0, T_ref - temp)           # cold premium
        gas_price += beta * max(0, (S0 - s_next)) / S0      # scarcity premium

        # Severe cold snap (<20Â°F) surge
        if temp < 20:
            gas_price *= 1.25 + 0.02 * (20 - temp)

        # Prevent collapse at low storage
        if s_next <= S_min + 0.2:
            gas_price = max(gas_price, 0.8 * ttf_landed)

        gas_price = min(gas_price, ttf_landed)
        if add_volatility:
            gas_price *= np.random.normal(1, sigma)

        power_price = heat_rate * gas_price + nonfuel
        S.append(s_next)
        prices.append(power_price)

    # --- Results ---
    df["Storage_Bcf"] = S[1:]
    df["PredictedPrice_$MWh"] = prices
    df["CargoOrdered"] = cargo_ordered
    df["CargoArrived"] = cargo_arrived

    # --- Evaluate if actuals exist ---
    if "NE_MAHUB_PK" in df.columns:
        actual = df["NE_MAHUB_PK"].astype(float)
        predicted = df["PredictedPrice_$MWh"]

        mae = mean_absolute_error(actual, predicted)
        rmse = np.sqrt(mean_squared_error(actual, predicted))
        mape = np.mean(np.abs((actual - predicted) / actual)) * 100

        print("ðŸ“Š Model Performance Summary")
        print(f"MAE  : {mae:.2f} $/MWh")
        print(f"RMSE : {rmse:.2f} $/MWh")
        print(f"MAPE : {mape:.2f}%")
        print(f"Period: {df['Date'].min().date()} â†’ {df['Date'].max().date()}")
        print(f"Avg Predicted: {predicted.mean():.1f} | Avg Actual: {actual.mean():.1f}")

        # --- Plot ---
        fig, ax1 = plt.subplots(figsize=(13,6))
        ax1.plot(df["Date"], actual, color="black", label="Actual NE_MAHUB_PK", linewidth=2)
        ax1.plot(df["Date"], predicted, color="tab:blue", label="Predicted Price", linewidth=2)
        ax1.set_xlabel("Date")
        ax1.set_ylabel("$/MWh")
        ax1.legend(loc="upper left")
        ax1.grid(True, alpha=0.3)

        ax2 = ax1.twinx()
        ax2.plot(df["Date"], df["Storage_Bcf"], color="tab:orange", linestyle="--", label="Storage (Bcf)")
        ax2.set_ylabel("Storage (Bcf)")
        ax2.legend(loc="upper right")
        plt.title("NEPOOL Power Price Forecast vs Actual â€” with LNG Storage Floor")
        plt.show()

    else:
        print("âš ï¸ No 'NE_MAHUB_PK' column found â€” skipping metrics & plot.")

    return df